<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor√≠a - Herramientas Contables</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../supabase-config.js"></script>
    <link rel="stylesheet" href="../../css/buttons.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <script src="../../check-auth.js"></script>

    <!-- Barra de navegaci√≥n -->
    <div class="nav-bar">
        <a href="../../index.html" class="nav-btn">üè† Inicio</a>
        <a href="../../index.html" class="nav-btn">‚Üê Volver</a>
    </div>

    <div class="container">
        <div class="header">
            <h1>üîç Auditor√≠a</h1>
            <p>Herramienta de auditor√≠a de estados contables</p>
        </div>

        <!-- Selector de Cliente -->
        <div class="cliente-selector">
            <div class="search-box">
                <div class="selector-group">
                    <label>Seleccionar Cliente:</label>
                    <select id="clienteSelect" class="input-text" onchange="cargarDashboard()">
                        <option value="">-- Seleccione un cliente --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <input type="text" id="clienteSearch" class="input-text" placeholder="üîç Filtrar clientes..." oninput="filtrarClientes()">
                </div>
            </div>
        </div>

        <!-- Dashboard (se muestra al seleccionar cliente) -->
        <div id="dashboard" style="display: none;">
            <!-- Info del Cliente Seleccionado -->
            <div class="cliente-info">
                <div class="cliente-datos">
                    <h3 id="clienteNombre"></h3>
                    <span id="clienteCuit"></span>
                </div>
                <button onclick="mostrarNuevaCuentaBancaria()" class="btn-primary">+ Nueva Cuenta Bancaria</button>
            </div>

            <!-- Panel de Cuentas Bancarias y Extractos -->
            <div class="cuentas-panel">
                <div class="info-box">
                    <strong>Panel de Extractos Bancarios:</strong> Visualice todas las cuentas bancarias del cliente con sus extractos mensuales.
                    Puede cargar nuevos extractos, editarlos, filtrar movimientos y descargar reportes.
                </div>

                <!-- Lista de Cuentas con Extractos -->
                <div id="cuentasList" class="cuentas-list">
                    <div class="empty-state">Seleccione un cliente para ver sus cuentas bancarias</div>
                </div>
            </div>
        </div>

        <!-- Estado vac√≠o inicial -->
        <div id="emptyState" class="empty-state-container">
            <div class="empty-icon">üè¶</div>
            <h3>Seleccione un Cliente</h3>
            <p>Elija un cliente del selector superior para ver sus cuentas bancarias y extractos mensuales.</p>
        </div>
    </div>

    <!-- Modal Nueva/Editar Cuenta Bancaria -->
    <div id="modalNuevaCuentaBancaria" class="modal hidden">
        <div class="modal-content-sm">
            <h3>Cuenta Bancaria</h3>
            <input type="hidden" id="cuentaBancariaId">
            <label>Banco:</label>
            <input type="text" id="cuentaBanco" placeholder="Ej: Banco Galicia" class="input-text mb-4">
            <label>Tipo de Cuenta:</label>
            <select id="cuentaTipo" class="input-text mb-4">
                <option value="Cuenta Corriente">Cuenta Corriente</option>
                <option value="Caja de Ahorro">Caja de Ahorro</option>
                <option value="Cuenta √önica">Cuenta √önica</option>
            </select>
            <label>N√∫mero de Cuenta / CBU:</label>
            <input type="text" id="cuentaNumero" placeholder="Ej: 0070001234567890123456" class="input-text mb-4">
            <label>Alias (Opcional):</label>
            <input type="text" id="cuentaAlias" placeholder="Ej: CUENTA.PRINCIPAL" class="input-text mb-4">
            <div class="btn-group">
                <button onclick="cerrarNuevaCuentaBancaria()" class="btn-secondary">Cancelar</button>
                <button onclick="guardarCuentaBancaria()" class="btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Extractos Mensuales -->
    <div id="modalExtractosMensuales" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Extractos Mensuales - <span id="extractosCuentaNombre"></span></h2>
                <button class="close-btn" onclick="cerrarExtractosMensuales()">‚úï</button>
            </div>

            <div class="btn-group mb-4">
                <button onclick="mostrarSubirExtracto()" class="btn-primary flex-1">üì§ Subir Extracto</button>
            </div>

            <div class="info-box">
                <strong>Formato:</strong> Suba el archivo Excel generado por el Conversor de Extractos Bancarios.<br>
                <strong>Columnas esperadas:</strong> Fecha | Descripci√≥n | Origen | Cr√©dito | D√©bito | Saldo
            </div>

            <div id="extractosMensualesList" class="extractos-list"></div>
        </div>
    </div>

    <!-- Modal Subir Extracto -->
    <div id="modalSubirExtracto" class="modal hidden">
        <div class="modal-content-sm">
            <h3>Subir Extracto</h3>
            <label>Mes:</label>
            <select id="extractoMes" class="input-text mb-4">
                <option value="1">Enero</option>
                <option value="2">Febrero</option>
                <option value="3">Marzo</option>
                <option value="4">Abril</option>
                <option value="5">Mayo</option>
                <option value="6">Junio</option>
                <option value="7">Julio</option>
                <option value="8">Agosto</option>
                <option value="9">Septiembre</option>
                <option value="10">Octubre</option>
                <option value="11">Noviembre</option>
                <option value="12">Diciembre</option>
            </select>
            <label>A√±o:</label>
            <input type="number" id="extractoAnio" placeholder="2024" class="input-text mb-4" min="2000" max="2100">
            <label>Archivo Excel:</label>
            <input type="file" id="extractoFile" accept=".xlsx,.xls" class="input-text mb-4" onchange="handleExtractoFileChange(event)">
            <div id="extractoFileInfo" class="file-info"></div>
            <div class="btn-group">
                <button onclick="cerrarSubirExtracto()" class="btn-secondary">Cancelar</button>
                <button onclick="procesarExtracto()" class="btn-primary">Procesar y Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Seleccionar Rango de Fechas -->
    <div id="modalRangoFechas" class="modal hidden">
        <div class="modal-content-sm">
            <h3>üìÖ Ver extractos por rango de fechas</h3>
            <p class="info-text">Seleccione un rango para ver y clasificar movimientos de m√∫ltiples meses a la vez.</p>

            <input type="hidden" id="rangoCuentaId">
            <input type="hidden" id="rangoCuentaNombre">

            <div class="rango-fechas-grid">
                <div class="rango-field">
                    <label>Desde:</label>
                    <div class="rango-selects">
                        <select id="rangoMesDesde" class="input-text">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        <input type="number" id="rangoAnioDesde" class="input-text" min="2000" max="2100" placeholder="A√±o">
                    </div>
                </div>
                <div class="rango-field">
                    <label>Hasta:</label>
                    <div class="rango-selects">
                        <select id="rangoMesHasta" class="input-text">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        <input type="number" id="rangoAnioHasta" class="input-text" min="2000" max="2100" placeholder="A√±o">
                    </div>
                </div>
            </div>

            <div class="btn-group mt-4">
                <button onclick="cerrarModalRangoFechas()" class="btn-secondary">Cancelar</button>
                <button onclick="cargarExtractosPorRango()" class="btn-primary">Ver Extractos</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalle de Extracto -->
    <div id="modalDetalleExtracto" class="modal hidden">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>üìä Detalle Extracto - <span id="detalleExtractoPeriodo"></span></h2>
                <button class="close-btn" onclick="cerrarDetalleExtracto()">‚úï</button>
            </div>

            <!-- Barra de herramientas -->
            <div class="btn-group mb-4 toolbar">
                <button onclick="agregarMovimiento()" class="btn-primary">+ Agregar Movimiento</button>
                <button onclick="restaurarMovimientos()" class="btn-warning">‚Ü©Ô∏è Restaurar Eliminados</button>
                <button onclick="restaurarDatosOriginales()" class="btn-secondary">üîÑ Restaurar Original</button>
                <button onclick="guardarCambiosExtracto()" class="btn-success">üíæ Guardar Cambios</button>
                <button onclick="descargarExtractoExcel()" class="btn-template">üì• Descargar Excel</button>
            </div>

            <!-- Filtros de texto -->
            <div class="filtros-extracto">
                <div class="filtro-item">
                    <label>Filtrar por Fecha:</label>
                    <input type="text" id="filtroFecha" placeholder="Ej: 15/01" class="input-text">
                </div>
                <div class="filtro-item filtro-desc">
                    <label>Filtrar por Descripci√≥n:</label>
                    <input type="text" id="filtroDescripcion" placeholder="Buscar en descripci√≥n..." class="input-text">
                </div>
                <div class="filtro-item">
                    <label>Filtrar por Origen:</label>
                    <input type="text" id="filtroOrigen" placeholder="Buscar origen..." class="input-text">
                </div>
                <div class="filtro-item filtro-btn">
                    <button onclick="limpiarFiltrosExtracto()" class="btn-secondary">Limpiar</button>
                </div>
            </div>

            <!-- Panel de Marcadores/Categor√≠as -->
            <div class="marcadores-panel">
                <!-- Asignaci√≥n masiva de marcadores -->
                <div class="asignar-marcador-section">
                    <div class="asignar-marcador-row">
                        <span class="asignar-label">üè∑Ô∏è Asignar a filtrados:</span>
                        <select id="marcadorAsignar" class="input-text marcador-select">
                            <!-- Opciones se llenan din√°micamente -->
                        </select>
                        <button onclick="asignarMarcadorFiltrados()" class="btn-primary btn-sm">Aplicar</button>
                        <button onclick="quitarMarcadorFiltrados()" class="btn-secondary btn-sm">Quitar categor√≠a</button>
                        <button onclick="abrirGestionCategorias()" class="btn-template btn-sm" title="Gestionar categor√≠as">‚öôÔ∏è Gestionar</button>
                    </div>
                </div>

                <!-- Filtro por marcadores -->
                <div class="filtro-marcadores-section">
                    <span class="filtro-marcadores-label">Filtrar por categor√≠a:</span>
                    <div id="filtroMarcadoresContainer" class="filtro-marcadores-container">
                        <!-- Checkboxes se llenan din√°micamente -->
                    </div>
                    <button onclick="limpiarFiltroMarcadores()" class="btn-secondary btn-xs">Limpiar</button>
                </div>
            </div>

            <!-- Estad√≠sticas -->
            <div id="detalleExtractoStats" class="stats-bar"></div>

            <!-- Tabla de movimientos -->
            <div class="preview-container">
                <div class="preview-table-container">
                    <table id="detalleExtractoTable" class="preview-table">
                        <thead>
                            <tr>
                                <th data-sort="categoria" onclick="ordenarPorColumna('categoria')" class="sortable categoria-col">Categor√≠a <span class="sort-indicator">‚áÖ</span></th>
                                <th data-sort="fecha" onclick="ordenarPorColumna('fecha')" class="sortable">Fecha <span class="sort-indicator">‚áÖ</span></th>
                                <th data-sort="descripcion" onclick="ordenarPorColumna('descripcion')" class="sortable">Descripci√≥n <span class="sort-indicator">‚áÖ</span></th>
                                <th data-sort="origen" onclick="ordenarPorColumna('origen')" class="sortable">Origen <span class="sort-indicator">‚áÖ</span></th>
                                <th data-sort="credito" onclick="ordenarPorColumna('credito')" class="sortable text-right">Cr√©dito <span class="sort-indicator">‚áÖ</span></th>
                                <th data-sort="debito" onclick="ordenarPorColumna('debito')" class="sortable text-right">D√©bito <span class="sort-indicator">‚áÖ</span></th>
                                <th data-sort="saldo" onclick="ordenarPorColumna('saldo')" class="sortable text-right">Saldo <span class="sort-indicator">‚áÖ</span></th>
                                <th class="actions-col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="detalleExtractoBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="info-box mt-4">
                <strong>Tips:</strong><br>
                ‚Ä¢ Haga clic en la descripci√≥n para editarla inline.<br>
                ‚Ä¢ <strong>Clasificar movimientos:</strong> Filtre por descripci√≥n, luego use "Asignar a filtrados" para categorizar todos los movimientos visibles.<br>
                ‚Ä¢ <strong>Filtrar por categor√≠a:</strong> Seleccione una o m√°s categor√≠as en los checkboxes para ver solo esos movimientos.
            </div>
        </div>
    </div>

    <!-- Modal Gesti√≥n de Categor√≠as -->
    <div id="modalGestionCategorias" class="modal hidden">
        <div class="modal-content modal-categorias">
            <div class="modal-header">
                <h2>‚öôÔ∏è Gesti√≥n de Categor√≠as</h2>
                <button class="close-btn" onclick="cerrarGestionCategorias()">‚úï</button>
            </div>

            <div class="info-box">
                <strong>Gesti√≥n de categor√≠as:</strong> Cree, edite o elimine categor√≠as para clasificar los movimientos bancarios.
                Los cambios se guardan autom√°ticamente en la base de datos.
            </div>

            <!-- Formulario para nueva categor√≠a -->
            <div class="nueva-categoria-form">
                <h4>Nueva Categor√≠a</h4>
                <div class="categoria-form-row">
                    <div class="categoria-form-field">
                        <label>ID (√∫nico):</label>
                        <input type="text" id="nuevaCategoriaId" class="input-text" placeholder="ej: gastos_varios">
                    </div>
                    <div class="categoria-form-field">
                        <label>Nombre:</label>
                        <input type="text" id="nuevaCategoriaNombre" class="input-text" placeholder="ej: Gastos Varios">
                    </div>
                    <div class="categoria-form-field categoria-color-field">
                        <label>Color:</label>
                        <input type="color" id="nuevaCategoriaColor" class="input-color" value="#64748b">
                    </div>
                    <div class="categoria-form-field categoria-btn-field">
                        <button onclick="agregarCategoria()" class="btn-primary">+ Agregar</button>
                    </div>
                </div>
            </div>

            <!-- Lista de categor√≠as existentes -->
            <div class="categorias-lista-container">
                <h4>Categor√≠as Existentes</h4>
                <div id="categoriasLista" class="categorias-lista">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>

            <div class="btn-group mt-4">
                <button onclick="cerrarGestionCategorias()" class="btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Categor√≠a -->
    <div id="modalEditarCategoria" class="modal hidden">
        <div class="modal-content-sm">
            <h3>Editar Categor√≠a</h3>
            <input type="hidden" id="editarCategoriaIdOriginal">
            <label>ID (√∫nico):</label>
            <input type="text" id="editarCategoriaId" class="input-text mb-4" placeholder="ej: gastos_varios">
            <label>Nombre:</label>
            <input type="text" id="editarCategoriaNombre" class="input-text mb-4" placeholder="ej: Gastos Varios">
            <label>Color:</label>
            <input type="color" id="editarCategoriaColor" class="input-color mb-4" value="#64748b">
            <div class="btn-group">
                <button onclick="cerrarEditarCategoria()" class="btn-secondary">Cancelar</button>
                <button onclick="guardarEdicionCategoria()" class="btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Script principal -->
    <script src="script.js"></script>
</body>
</html>
