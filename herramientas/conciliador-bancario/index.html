<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conciliador Bancario</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../supabase-config.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <script src="../../check-auth.js"></script>
    <div class="nav-bar">
        <a href="../../index.html" class="nav-btn" title="Volver al inicio">
            <span class="nav-icon">üè†</span>
            <span class="nav-text">Inicio</span>
        </a>
        <a href="../../index.html" class="nav-btn" title="Men√∫ principal">
            <span class="nav-icon">‚Üê</span>
            <span class="nav-text">Volver</span>
        </a>
    </div>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>üîÑ Conciliador Bancario</h1>
                <p class="subtitle">Compara movimientos del Mayor Contable con Extractos Bancarios</p>
            </div>

            <!-- Paso 1: Selecci√≥n de tipo de conciliaci√≥n -->
            <div class="step" id="step-tipo">
                <h2 class="step-title">
                    <span class="step-number">1</span>
                    ¬øQu√© desea conciliar?
                </h2>
                <div class="type-grid">
                    <button class="type-btn" data-tipo="creditos">
                        <div class="type-btn-icon">üí∞</div>
                        <div class="type-btn-title">Cr√©ditos</div>
                        <div class="type-btn-subtitle">Entradas de dinero (Haber del Mayor = Cr√©dito del Extracto)</div>
                    </button>
                    <button class="type-btn" data-tipo="debitos">
                        <div class="type-btn-icon">üí∏</div>
                        <div class="type-btn-title">D√©bitos</div>
                        <div class="type-btn-subtitle">Salidas de dinero (Debe del Mayor = D√©bito del Extracto)</div>
                    </button>
                </div>
            </div>

            <!-- Paso 2: Carga de archivos -->
            <div class="step hidden" id="step-archivos">
                <h2 class="step-title">
                    <span class="step-number">2</span>
                    Cargar archivos
                </h2>

                <!-- Mayor Contable -->
                <div class="file-section">
                    <div class="file-header">
                        <h3>üìí Mayor Contable</h3>
                        <button class="btn-template" id="btnPlantillaMayor">üì• Descargar Plantilla</button>
                    </div>
                    <div class="file-drop-zone" id="dropZoneMayor">
                        <div class="upload-icon">üì§</div>
                        <div class="upload-text">Haz clic para seleccionar un archivo Excel</div>
                        <div class="upload-subtext">o arrastra tu archivo aqu√≠</div>
                        <input type="file" id="fileMayor" accept=".xlsx,.xls" style="display: none;">
                    </div>
                    <div id="previewMayor" class="file-preview hidden">
                        <span class="file-icon">‚úÖ</span>
                        <span id="fileNameMayor"></span>
                        <span class="record-count" id="recordCountMayor"></span>
                        <button class="btn-remove" id="btnRemoveMayor">‚úï</button>
                    </div>
                </div>

                <!-- Extracto Bancario -->
                <div class="file-section">
                    <div class="file-header">
                        <h3>üè¶ Extracto Bancario</h3>
                        <button class="btn-template" id="btnPlantillaExtracto">üì• Descargar Plantilla</button>
                    </div>
                    <div class="file-drop-zone" id="dropZoneExtracto">
                        <div class="upload-icon">üì§</div>
                        <div class="upload-text">Haz clic para seleccionar un archivo Excel</div>
                        <div class="upload-subtext">o arrastra tu archivo aqu√≠</div>
                        <input type="file" id="fileExtracto" accept=".xlsx,.xls" style="display: none;">
                    </div>
                    <div id="previewExtracto" class="file-preview hidden">
                        <span class="file-icon">‚úÖ</span>
                        <span id="fileNameExtracto"></span>
                        <span class="record-count" id="recordCountExtracto"></span>
                        <button class="btn-remove" id="btnRemoveExtracto">‚úï</button>
                    </div>
                </div>
            </div>

            <!-- Paso 3: Configuraci√≥n de tolerancias -->
            <div class="step hidden" id="step-tolerancias">
                <h2 class="step-title">
                    <span class="step-number">3</span>
                    Configuraci√≥n de tolerancias
                </h2>
                <div class="tolerance-grid">
                    <div class="tolerance-item">
                        <label for="toleranciaFecha">Tolerancia de fechas (d√≠as)</label>
                        <input type="number" id="toleranciaFecha" value="30" min="0" max="365" class="input-number">
                        <span class="tolerance-hint">¬± d√≠as de diferencia permitida</span>
                    </div>
                    <div class="tolerance-item">
                        <label for="toleranciaImporte">Tolerancia de importes ($)</label>
                        <input type="number" id="toleranciaImporte" value="20000" min="0" step="1000" class="input-number">
                        <span class="tolerance-hint">¬± diferencia permitida en pesos</span>
                    </div>
                </div>
            </div>

            <!-- Paso 4: Ejecutar conciliaci√≥n -->
            <div class="step hidden" id="step-ejecutar">
                <h2 class="step-title">
                    <span class="step-number">4</span>
                    Ejecutar conciliaci√≥n
                </h2>
                <button id="btnConciliar" class="btn-conciliar">
                    üîç Conciliar Movimientos
                </button>
            </div>

            <!-- Mensajes de error y √©xito -->
            <div id="errorBox" class="message-box error-box hidden"></div>
            <div id="successBox" class="message-box success-box hidden"></div>

            <!-- Resultados -->
            <div id="resultados" class="results-section hidden">
                <h2 class="results-title">üìä Resultados de Conciliaci√≥n</h2>

                <!-- Resumen -->
                <div class="results-summary">
                    <div class="summary-card success">
                        <div class="summary-icon">‚úÖ</div>
                        <div class="summary-value" id="totalConciliados">0</div>
                        <div class="summary-label">Movimientos conciliados</div>
                    </div>
                    <div class="summary-card warning">
                        <div class="summary-icon">‚ùå</div>
                        <div class="summary-value" id="mayorNoConciliado">0</div>
                        <div class="summary-label">Mayor sin conciliar</div>
                    </div>
                    <div class="summary-card warning">
                        <div class="summary-icon">‚ùå</div>
                        <div class="summary-value" id="extractoNoConciliado">0</div>
                        <div class="summary-label">Extracto sin conciliar</div>
                    </div>
                </div>

                <!-- Totales -->
                <div class="totals-box">
                    <div class="total-row">
                        <span class="total-label">Total Mayor:</span>
                        <span class="total-value" id="totalMayor">$0,00</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">Total Extracto:</span>
                        <span class="total-value" id="totalExtracto">$0,00</span>
                    </div>
                    <div class="total-row diferencia">
                        <span class="total-label">Diferencia:</span>
                        <span class="total-value" id="diferencia">$0,00</span>
                    </div>
                </div>

                <!-- Tabs para ver detalles -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="conciliados">Conciliados</button>
                    <button class="tab-btn" data-tab="mayor-pendiente">Mayor Pendiente</button>
                    <button class="tab-btn" data-tab="extracto-pendiente">Extracto Pendiente</button>
                </div>

                <!-- Tabla de conciliados -->
                <div class="tab-content active" id="tab-conciliados">
                    <div class="table-wrapper">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th colspan="4" class="header-group mayor">MAYOR CONTABLE</th>
                                    <th class="separator"></th>
                                    <th colspan="4" class="header-group extracto">EXTRACTO BANCARIO</th>
                                    <th class="header-diff">Dif.</th>
                                    <th class="header-action">Acci√≥n</th>
                                </tr>
                                <tr>
                                    <th>Fecha</th>
                                    <th>N¬∫</th>
                                    <th>Leyenda</th>
                                    <th class="text-right">Importe</th>
                                    <th class="separator"></th>
                                    <th>Fecha</th>
                                    <th>Descripci√≥n</th>
                                    <th>Origen</th>
                                    <th class="text-right">Importe</th>
                                    <th class="text-right">$</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tablaConciliados"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tabla Mayor Pendiente -->
                <div class="tab-content" id="tab-mayor-pendiente">
                    <div class="panel-header-pendiente">
                        <h3>Mayor Pendiente <span id="countMayorPendiente">(0)</span></h3>
                        <button class="btn-filtros" id="btnFiltrosMayor" onclick="toggleFiltros('mayor')">
                            üîç Filtros ‚ñº
                        </button>
                    </div>

                    <!-- Panel de filtros Mayor -->
                    <div id="filtros-mayor" class="filtros-panel hidden">
                        <div class="filtros-grid">
                            <div class="filtro-grupo">
                                <label>Fecha desde:</label>
                                <input type="date" id="filtroMayorFechaDesde" class="filtro-input">
                            </div>
                            <div class="filtro-grupo">
                                <label>Fecha hasta:</label>
                                <input type="date" id="filtroMayorFechaHasta" class="filtro-input">
                            </div>
                            <div class="filtro-grupo filtro-importe">
                                <label>Importe:</label>
                                <div class="filtro-importe-wrapper">
                                    <select id="filtroMayorImporteTipo" class="filtro-select" onchange="toggleSegundoImporte('mayor')">
                                        <option value="">-- Seleccionar --</option>
                                        <option value="mayor">Mayor que</option>
                                        <option value="menor">Menor que</option>
                                        <option value="igual">Igual a</option>
                                        <option value="entre">Entre</option>
                                    </select>
                                    <input type="number" id="filtroMayorImporteValor" class="filtro-input filtro-numero" placeholder="Monto" step="0.01">
                                    <input type="number" id="filtroMayorImporteValor2" class="filtro-input filtro-numero hidden" placeholder="Monto m√°x" step="0.01">
                                </div>
                            </div>
                            <div class="filtro-grupo">
                                <label>N¬∫ Asiento:</label>
                                <input type="text" id="filtroMayorNumeroAsiento" class="filtro-input" placeholder="Buscar...">
                            </div>
                            <div class="filtro-grupo filtro-ancho">
                                <label>Leyenda:</label>
                                <input type="text" id="filtroMayorLeyenda" class="filtro-input" placeholder="Buscar en leyenda...">
                            </div>
                            <div class="filtro-grupo">
                                <label>C/E:</label>
                                <select id="filtroMayorCE" class="filtro-select">
                                    <option value="todos">Todos</option>
                                    <option value="C">C</option>
                                    <option value="E">E</option>
                                </select>
                            </div>
                            <div class="filtro-grupo">
                                <label>Tipo:</label>
                                <select id="filtroMayorTipo" class="filtro-select">
                                    <option value="todos">Todos</option>
                                </select>
                            </div>
                        </div>
                        <div class="filtros-acciones">
                            <button class="btn-aplicar-filtro" onclick="aplicarFiltrosMayor()">Aplicar Filtros</button>
                            <button class="btn-limpiar-filtro" onclick="limpiarFiltrosMayor()">Limpiar</button>
                        </div>
                    </div>

                    <!-- Contador de resultados filtrados -->
                    <div id="filtrosMayorResultado" class="filtros-resultado hidden">
                        Mostrando <span id="filtrosMayorMostrados">0</span> de <span id="filtrosMayorTotal">0</span> movimientos
                    </div>

                    <!-- Badges de filtros activos -->
                    <div id="filtrosMayorActivos" class="filtros-activos hidden"></div>

                    <div class="table-wrapper">
                        <table class="results-table table-selectable">
                            <thead>
                                <tr>
                                    <th class="col-checkbox"><input type="checkbox" id="selectAllMayor" title="Seleccionar todos"></th>
                                    <th class="columna-ordenable" data-columna="fecha" onclick="ordenarPorColumna('mayor', 'fecha')">
                                        Fecha <span class="icono-orden">‚ñº</span>
                                    </th>
                                    <th class="columna-ordenable" data-columna="numeroAsiento" onclick="ordenarPorColumna('mayor', 'numeroAsiento')">
                                        N¬∫ Asiento <span class="icono-orden">‚Üï</span>
                                    </th>
                                    <th class="columna-ordenable" data-columna="ce" onclick="ordenarPorColumna('mayor', 'ce')">
                                        C/E <span class="icono-orden">‚Üï</span>
                                    </th>
                                    <th class="columna-ordenable" data-columna="tipo" onclick="ordenarPorColumna('mayor', 'tipo')">
                                        Tipo <span class="icono-orden">‚Üï</span>
                                    </th>
                                    <th class="columna-ordenable" data-columna="leyenda" onclick="ordenarPorColumna('mayor', 'leyenda')">
                                        Leyenda <span class="icono-orden">‚Üï</span>
                                    </th>
                                    <th class="columna-ordenable text-right" data-columna="debe" onclick="ordenarPorColumna('mayor', 'debe')">
                                        Debe <span class="icono-orden">‚Üï</span>
                                    </th>
                                    <th class="columna-ordenable text-right" data-columna="haber" onclick="ordenarPorColumna('mayor', 'haber')">
                                        Haber <span class="icono-orden">‚Üï</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tablaMayorPendiente"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tabla Extracto Pendiente -->
                <div class="tab-content" id="tab-extracto-pendiente">
                    <div class="panel-header-pendiente">
                        <h3>Extracto Pendiente <span id="countExtractoPendiente">(0)</span></h3>
                        <button class="btn-filtros" id="btnFiltrosExtracto" onclick="toggleFiltros('extracto')">
                            üîç Filtros ‚ñº
                        </button>
                    </div>

                    <!-- Panel de filtros Extracto -->
                    <div id="filtros-extracto" class="filtros-panel hidden">
                        <div class="filtros-grid">
                            <div class="filtro-grupo">
                                <label>Fecha desde:</label>
                                <input type="date" id="filtroExtractoFechaDesde" class="filtro-input">
                            </div>
                            <div class="filtro-grupo">
                                <label>Fecha hasta:</label>
                                <input type="date" id="filtroExtractoFechaHasta" class="filtro-input">
                            </div>
                            <div class="filtro-grupo filtro-importe">
                                <label>Importe:</label>
                                <div class="filtro-importe-wrapper">
                                    <select id="filtroExtractoImporteTipo" class="filtro-select" onchange="toggleSegundoImporte('extracto')">
                                        <option value="">-- Seleccionar --</option>
                                        <option value="mayor">Mayor que</option>
                                        <option value="menor">Menor que</option>
                                        <option value="igual">Igual a</option>
                                        <option value="entre">Entre</option>
                                    </select>
                                    <input type="number" id="filtroExtractoImporteValor" class="filtro-input filtro-numero" placeholder="Monto" step="0.01">
                                    <input type="number" id="filtroExtractoImporteValor2" class="filtro-input filtro-numero hidden" placeholder="Monto m√°x" step="0.01">
                                </div>
                            </div>
                            <div class="filtro-grupo">
                                <label>Origen:</label>
                                <input type="text" id="filtroExtractoOrigen" class="filtro-input" placeholder="Buscar...">
                            </div>
                            <div class="filtro-grupo filtro-ancho">
                                <label>Descripci√≥n:</label>
                                <input type="text" id="filtroExtractoDescripcion" class="filtro-input" placeholder="Buscar en descripci√≥n...">
                            </div>
                        </div>
                        <div class="filtros-acciones">
                            <button class="btn-aplicar-filtro" onclick="aplicarFiltrosExtracto()">Aplicar Filtros</button>
                            <button class="btn-limpiar-filtro" onclick="limpiarFiltrosExtracto()">Limpiar</button>
                        </div>
                    </div>

                    <!-- Contador de resultados filtrados -->
                    <div id="filtrosExtractoResultado" class="filtros-resultado hidden">
                        Mostrando <span id="filtrosExtractoMostrados">0</span> de <span id="filtrosExtractoTotal">0</span> movimientos
                    </div>

                    <!-- Badges de filtros activos -->
                    <div id="filtrosExtractoActivos" class="filtros-activos hidden"></div>

                    <div class="table-wrapper">
                        <table class="results-table table-selectable">
                            <thead>
                                <tr>
                                    <th class="col-checkbox"><input type="checkbox" id="selectAllExtracto" title="Seleccionar todos"></th>
                                    <th class="columna-ordenable" data-columna="fecha" onclick="ordenarPorColumna('extracto', 'fecha')">
                                        Fecha <span class="icono-orden">‚ñº</span>
                                    </th>
                                    <th class="columna-ordenable" data-columna="descripcion" onclick="ordenarPorColumna('extracto', 'descripcion')">
                                        Descripci√≥n <span class="icono-orden">‚Üï</span>
                                    </th>
                                    <th class="columna-ordenable" data-columna="origen" onclick="ordenarPorColumna('extracto', 'origen')">
                                        Origen <span class="icono-orden">‚Üï</span>
                                    </th>
                                    <th class="columna-ordenable text-right" data-columna="debito" onclick="ordenarPorColumna('extracto', 'debito')">
                                        D√©bito <span class="icono-orden">‚Üï</span>
                                    </th>
                                    <th class="columna-ordenable text-right" data-columna="credito" onclick="ordenarPorColumna('extracto', 'credito')">
                                        Cr√©dito <span class="icono-orden">‚Üï</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tablaExtractoPendiente"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Barra de selecci√≥n flotante para conciliaci√≥n manual -->
                <div id="selectionBar" class="selection-bar hidden">
                    <div class="selection-summary">
                        <div class="selection-group">
                            <span class="selection-label">Mayor:</span>
                            <span id="selMayorCount" class="selection-count">0</span>
                            <span class="selection-amount">(<span id="selMayorTotal">$0,00</span>)</span>
                        </div>
                        <div class="selection-separator">|</div>
                        <div class="selection-group">
                            <span class="selection-label">Extracto:</span>
                            <span id="selExtractoCount" class="selection-count">0</span>
                            <span class="selection-amount">(<span id="selExtractoTotal">$0,00</span>)</span>
                        </div>
                        <div class="selection-separator">|</div>
                        <div class="selection-group selection-diff">
                            <span class="selection-label">Diferencia:</span>
                            <span id="selDiferencia" class="selection-diff-value">$0,00</span>
                        </div>
                    </div>
                    <div class="selection-actions">
                        <button id="btnLimpiarSeleccion" class="btn-selection-clear" title="Limpiar selecci√≥n">‚úï Limpiar</button>
                        <button id="btnVincular" class="btn-vincular" disabled>üîó Vincular como Conciliados</button>
                    </div>
                </div>

                <!-- Bot√≥n de descarga -->
                <button id="btnDescargar" class="btn-download">
                    üì• Descargar Reporte Excel
                </button>
            </div>

            <!-- Bot√≥n Nueva Conciliaci√≥n -->
            <div id="btnNuevaContainer" class="hidden">
                <button id="btnNuevaConciliacion" class="btn-secondary btn-full">
                    üîÑ Nueva Conciliaci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de progreso -->
    <div id="overlay-progreso" class="overlay-progreso"></div>
    <div id="modal-progreso" class="modal-progreso">
        <h3>Procesando Conciliaci√≥n</h3>
        <div class="barra-contenedor">
            <div id="barra-progreso" class="barra-progreso"></div>
        </div>
        <div id="porcentaje-progreso" class="porcentaje-progreso">0%</div>
        <div id="paso-progreso" class="paso-progreso">Paso 1 de 4</div>
        <div id="mensaje-progreso" class="mensaje-progreso">Iniciando...</div>
        <div id="contador-progreso" class="contador-progreso"></div>
        <div id="conciliados-progreso" class="conciliados-progreso"></div>
    </div>

    <script src="script.js"></script>
</body>
</html>
