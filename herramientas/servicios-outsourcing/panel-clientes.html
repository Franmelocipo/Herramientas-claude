<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Clientes - Sistema Contable</title>

    <!-- Estilos -->
    <link rel="stylesheet" href="../../css/buttons.css">
    <link rel="stylesheet" href="styles.css">

    <!-- XLSX para importar Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Estilos espec√≠ficos para gesti√≥n de clientes */
        .clientes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--spacing-lg);
        }

        .cliente-card {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .cliente-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .cliente-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
        }

        .cliente-card-info h3 {
            font-size: var(--font-size-lg);
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .cliente-card-info .cuit {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .cliente-card-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .cliente-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
            padding: var(--spacing-md) 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        .cliente-stat {
            text-align: center;
        }

        .cliente-stat-value {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--primary-color);
        }

        .cliente-stat-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .cliente-card-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .cliente-card-actions .btn {
            flex: 1;
            font-size: var(--font-size-xs);
            padding: 8px 12px;
        }

        /* Modal de plan de cuentas */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius-lg);
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: var(--font-size-xl);
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--spacing-lg);
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
        }

        /* Upload area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: var(--spacing-lg);
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(44, 82, 130, 0.02);
        }

        .upload-area.dragging {
            border-color: var(--primary-color);
            background: rgba(44, 82, 130, 0.05);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .upload-hint {
            font-size: var(--font-size-sm);
            color: var(--text-light);
        }

        /* Lista de cuentas */
        .cuentas-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }

        .cuenta-item {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border-color);
        }

        .cuenta-item:last-child {
            border-bottom: none;
        }

        .cuenta-item:nth-child(odd) {
            background: var(--bg-secondary);
        }

        .cuenta-codigo {
            font-weight: 600;
            color: var(--primary-color);
            min-width: 120px;
            font-family: monospace;
        }

        .cuenta-nombre {
            color: var(--text-primary);
            flex: 1;
        }

        /* Estad√≠sticas del plan */
        .plan-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .plan-stat-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            text-align: center;
        }

        .plan-stat-value {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--primary-color);
        }

        .plan-stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        /* B√∫squeda */
        .search-box {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: var(--font-size-base);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }

        /* Alert */
        .alert {
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
        }

        .alert-info {
            background: rgba(66, 153, 225, 0.1);
            color: var(--info-color);
            border: 1px solid var(--info-color);
        }

        .alert-success {
            background: rgba(72, 187, 120, 0.1);
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
        }

        .alert-warning {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        .alert-error {
            background: rgba(229, 62, 62, 0.1);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: var(--spacing-md);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: var(--font-size-base);
        }

        /* Plantilla descarga */
        .plantilla-info {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .plantilla-info-icon {
            font-size: 24px;
        }

        .plantilla-info-text {
            flex: 1;
        }

        .plantilla-info-text strong {
            display: block;
            margin-bottom: 4px;
        }

        .plantilla-info-text span {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Gesti√≥n</h1>
                <div class="user-info">
                    <span id="currentUserName">Cargando...</span>
                </div>
                <span class="user-role">Admin</span>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">Administraci√≥n</span>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="panel-admin.html" class="nav-link">
                                <span class="icon">üìã</span>
                                Comprobantes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="panel-clientes.html" class="nav-link active">
                                <span class="icon">üè¢</span>
                                Gesti√≥n de Clientes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="panel-usuarios.html" class="nav-link">
                                <span class="icon">üë•</span>
                                Gesti√≥n de Usuarios
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="btn-logout" onclick="auth.logout()">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </aside>

        <!-- Contenido principal -->
        <main class="main-content">
            <div class="content-header">
                <h1>Gesti√≥n de Clientes</h1>
                <p>Administra los clientes y sus planes de cuentas para conversiones</p>
            </div>

            <!-- Barra de b√∫squeda -->
            <div class="search-box">
                <input type="text" id="searchClientes" placeholder="Buscar cliente por nombre o CUIT..." onkeyup="filtrarClientes()">
            </div>

            <!-- Grid de clientes -->
            <div id="clientesContainer" class="clientes-grid">
                <div class="loading-text">Cargando clientes...</div>
            </div>
        </main>
    </div>

    <!-- Modal Plan de Cuentas -->
    <div id="modalPlanCuentas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalClienteNombre">Plan de Cuentas</h2>
                <button class="modal-close" onclick="cerrarModalPlan()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Secci√≥n de importaci√≥n -->
                <div id="seccionImportar">
                    <h3 style="margin-bottom: var(--spacing-md);">Importar Plan de Cuentas</h3>

                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">Haga clic o arrastre un archivo Excel aqu√≠</div>
                        <div class="upload-hint">Formatos soportados: .xlsx, .xls</div>
                    </div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="procesarArchivoExcel(event)">

                    <div class="plantilla-info">
                        <span class="plantilla-info-icon">üìÑ</span>
                        <div class="plantilla-info-text">
                            <strong>Formato del archivo</strong>
                            <span>El Excel debe tener las columnas: CODIGO, CUENTA (o NOMBRE)</span>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="descargarPlantilla()">
                            Descargar Plantilla
                        </button>
                    </div>
                </div>

                <!-- Secci√≥n de vista del plan actual -->
                <div id="seccionPlanActual" style="margin-top: var(--spacing-xl);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                        <h3>Plan de Cuentas Actual</h3>
                        <button class="btn btn-danger btn-sm" onclick="eliminarPlanCuentas()" id="btnEliminarPlan" style="display: none;">
                            üóëÔ∏è Eliminar Plan
                        </button>
                    </div>

                    <div id="planStats" class="plan-stats" style="display: none;">
                        <div class="plan-stat-card">
                            <div class="plan-stat-value" id="statTotalCuentas">0</div>
                            <div class="plan-stat-label">Cuentas Totales</div>
                        </div>
                        <div class="plan-stat-card">
                            <div class="plan-stat-value" id="statFechaImport">-</div>
                            <div class="plan-stat-label">√öltima Importaci√≥n</div>
                        </div>
                        <div class="plan-stat-card">
                            <div class="plan-stat-value" id="statCuentasMapeadas">0</div>
                            <div class="plan-stat-label">Cuentas Mapeadas</div>
                        </div>
                    </div>

                    <div id="alertNoPlan" class="alert alert-info">
                        Este cliente no tiene un plan de cuentas cargado. Importe un archivo Excel para comenzar.
                    </div>

                    <div id="listaCuentasContainer" style="display: none;">
                        <div class="search-box" style="margin-bottom: var(--spacing-sm);">
                            <input type="text" id="searchCuentas" placeholder="Buscar cuenta..." onkeyup="filtrarCuentas()">
                        </div>
                        <div class="cuentas-list" id="listaCuentas"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModalPlan()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Cargando...</div>
    </div>

    <!-- Script de autenticaci√≥n -->
    <script src="auth.js"></script>

    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        let clienteSeleccionado = null;
        let clientes = [];
        let planCuentasActual = [];

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar sesi√≥n admin
            const session = auth.requireRole('admin');
            if (!session) return;

            document.getElementById('currentUserName').textContent = session.nombre;

            // Inicializar Supabase
            if (!window.supabaseClient) {
                window.supabaseClient = window.supabase.createClient(
                    'https://wnpjvnmyfkgtpwqnbmxa.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InducGp2bm15ZmtndHB3cW5ibXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMzE5OTAsImV4cCI6MjA3ODcwNzk5MH0.XmYGTMuQBJBpUMAij90T6z4SlCMugVWuWdwJ84GiPn8'
                );
            }

            // Cargar clientes
            await cargarClientes();

            // Configurar drag and drop
            configurarDragDrop();
        });

        // ============================================
        // CARGAR CLIENTES
        // ============================================
        async function cargarClientes() {
            try {
                const { data, error } = await supabaseClient
                    .from('clientes')
                    .select('*')
                    .order('razon_social', { ascending: true });

                if (error) throw error;

                clientes = data || [];

                // Cargar conteo de cuentas por cliente
                for (const cliente of clientes) {
                    const { count } = await supabaseClient
                        .from('plan_cuentas_cliente')
                        .select('*', { count: 'exact', head: true })
                        .eq('cliente_id', cliente.id);

                    cliente.cantidadCuentas = count || 0;

                    // Cargar cantidad de mapeos
                    const { count: countMapeos } = await supabaseClient
                        .from('mapeo_cuentas_cliente')
                        .select('*', { count: 'exact', head: true })
                        .eq('cliente_id', cliente.id);

                    cliente.cantidadMapeos = countMapeos || 0;
                }

                renderizarClientes(clientes);

            } catch (err) {
                console.error('Error cargando clientes:', err);
                document.getElementById('clientesContainer').innerHTML =
                    '<div class="alert alert-error">Error al cargar clientes: ' + err.message + '</div>';
            }
        }

        // ============================================
        // RENDERIZAR CLIENTES
        // ============================================
        function renderizarClientes(listaClientes) {
            const container = document.getElementById('clientesContainer');

            if (!listaClientes || listaClientes.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No hay clientes registrados</div>';
                return;
            }

            container.innerHTML = listaClientes.map(cliente => `
                <div class="cliente-card" data-id="${cliente.id}">
                    <div class="cliente-card-header">
                        <div class="cliente-card-info">
                            <h3>${cliente.razon_social || cliente.nombre || 'Sin nombre'}</h3>
                            <span class="cuit">${cliente.cuit || 'Sin CUIT'}</span>
                        </div>
                        <div class="cliente-card-icon">üè¢</div>
                    </div>
                    <div class="cliente-card-stats">
                        <div class="cliente-stat">
                            <div class="cliente-stat-value">${cliente.cantidadCuentas || 0}</div>
                            <div class="cliente-stat-label">Cuentas</div>
                        </div>
                        <div class="cliente-stat">
                            <div class="cliente-stat-value">${cliente.cantidadMapeos || 0}</div>
                            <div class="cliente-stat-label">Mapeos</div>
                        </div>
                    </div>
                    <div class="cliente-card-actions">
                        <button class="btn btn-primary" onclick="abrirModalPlan(${cliente.id}, '${(cliente.razon_social || cliente.nombre || '').replace(/'/g, "\\'")}')">
                            üìã Plan de Cuentas
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // FILTRAR CLIENTES
        // ============================================
        function filtrarClientes() {
            const filtro = document.getElementById('searchClientes').value.toLowerCase();

            const clientesFiltrados = clientes.filter(cliente => {
                const nombre = (cliente.razon_social || cliente.nombre || '').toLowerCase();
                const cuit = (cliente.cuit || '').toLowerCase();
                return nombre.includes(filtro) || cuit.includes(filtro);
            });

            renderizarClientes(clientesFiltrados);
        }

        // ============================================
        // MODAL PLAN DE CUENTAS
        // ============================================
        async function abrirModalPlan(clienteId, clienteNombre) {
            clienteSeleccionado = clienteId;
            document.getElementById('modalClienteNombre').textContent = `Plan de Cuentas - ${clienteNombre}`;
            document.getElementById('modalPlanCuentas').classList.add('active');

            // Cargar plan de cuentas actual
            await cargarPlanCuentasCliente(clienteId);
        }

        function cerrarModalPlan() {
            document.getElementById('modalPlanCuentas').classList.remove('active');
            clienteSeleccionado = null;
            planCuentasActual = [];
        }

        // ============================================
        // CARGAR PLAN DE CUENTAS DEL CLIENTE
        // ============================================
        async function cargarPlanCuentasCliente(clienteId) {
            mostrarLoading('Cargando plan de cuentas...');

            try {
                const { data, error } = await supabaseClient
                    .from('plan_cuentas_cliente')
                    .select('*')
                    .eq('cliente_id', clienteId)
                    .order('codigo', { ascending: true });

                if (error) throw error;

                planCuentasActual = data || [];

                // Tambi√©n cargar mapeos
                const { data: mapeos } = await supabaseClient
                    .from('mapeo_cuentas_cliente')
                    .select('*')
                    .eq('cliente_id', clienteId);

                const cantidadMapeos = mapeos ? mapeos.length : 0;

                ocultarLoading();

                if (planCuentasActual.length > 0) {
                    // Mostrar estad√≠sticas
                    document.getElementById('planStats').style.display = 'grid';
                    document.getElementById('statTotalCuentas').textContent = planCuentasActual.length;
                    document.getElementById('statCuentasMapeadas').textContent = cantidadMapeos;

                    // Fecha de √∫ltima importaci√≥n
                    const ultimaFecha = planCuentasActual[0]?.created_at;
                    if (ultimaFecha) {
                        const fecha = new Date(ultimaFecha);
                        document.getElementById('statFechaImport').textContent = fecha.toLocaleDateString('es-AR');
                    }

                    document.getElementById('alertNoPlan').style.display = 'none';
                    document.getElementById('listaCuentasContainer').style.display = 'block';
                    document.getElementById('btnEliminarPlan').style.display = 'inline-flex';

                    renderizarCuentas(planCuentasActual);
                } else {
                    document.getElementById('planStats').style.display = 'none';
                    document.getElementById('alertNoPlan').style.display = 'block';
                    document.getElementById('listaCuentasContainer').style.display = 'none';
                    document.getElementById('btnEliminarPlan').style.display = 'none';
                }

            } catch (err) {
                ocultarLoading();
                console.error('Error cargando plan:', err);
                alert('Error al cargar el plan de cuentas: ' + err.message);
            }
        }

        // ============================================
        // RENDERIZAR CUENTAS
        // ============================================
        function renderizarCuentas(cuentas) {
            const lista = document.getElementById('listaCuentas');

            if (cuentas.length === 0) {
                lista.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No hay cuentas</div>';
                return;
            }

            lista.innerHTML = cuentas.map(cuenta => `
                <div class="cuenta-item">
                    <span class="cuenta-codigo">${cuenta.codigo}</span>
                    <span class="cuenta-nombre">${cuenta.nombre}</span>
                </div>
            `).join('');
        }

        // ============================================
        // FILTRAR CUENTAS
        // ============================================
        function filtrarCuentas() {
            const filtro = document.getElementById('searchCuentas').value.toLowerCase();

            const cuentasFiltradas = planCuentasActual.filter(cuenta => {
                return cuenta.codigo.toLowerCase().includes(filtro) ||
                       cuenta.nombre.toLowerCase().includes(filtro);
            });

            renderizarCuentas(cuentasFiltradas);
        }

        // ============================================
        // PROCESAR ARCHIVO EXCEL
        // ============================================
        async function procesarArchivoExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!clienteSeleccionado) {
                alert('Error: No hay cliente seleccionado');
                return;
            }

            mostrarLoading('Procesando archivo Excel...');

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { raw: true });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });

                if (jsonData.length < 2) {
                    ocultarLoading();
                    alert('El archivo est√° vac√≠o o no tiene datos');
                    return;
                }

                // Buscar columnas
                const headers = jsonData[0];
                const findCol = (names) => {
                    for (const name of names) {
                        const idx = headers.findIndex(h =>
                            h && String(h).trim().toLowerCase() === name.toLowerCase()
                        );
                        if (idx !== -1) return idx;
                    }
                    return -1;
                };

                const colCodigo = findCol(['codigo', 'cod', 'c√≥digo', 'cod_cuenta', 'codigo_cuenta']);
                const colNombre = findCol(['cuenta', 'nombre', 'descripcion', 'descripci√≥n', 'nombre_cuenta']);

                if (colCodigo === -1 || colNombre === -1) {
                    ocultarLoading();
                    alert('No se encontraron las columnas requeridas (CODIGO, CUENTA).\nAseg√∫rese de que el archivo tenga las columnas correctas.');
                    return;
                }

                // Procesar filas
                const cuentas = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    const codigo = row[colCodigo] ? String(row[colCodigo]).trim() : '';
                    const nombre = row[colNombre] ? String(row[colNombre]).trim() : '';

                    if (codigo && nombre) {
                        cuentas.push({
                            cliente_id: clienteSeleccionado,
                            codigo: codigo,
                            nombre: nombre
                        });
                    }
                }

                if (cuentas.length === 0) {
                    ocultarLoading();
                    alert('No se encontraron cuentas v√°lidas en el archivo');
                    return;
                }

                // Confirmar importaci√≥n
                const confirmar = confirm(`Se encontraron ${cuentas.length} cuentas.\n\n¬øDesea importarlas? Esto reemplazar√° el plan de cuentas existente.`);

                if (!confirmar) {
                    ocultarLoading();
                    return;
                }

                // Eliminar plan existente
                actualizarLoadingText('Eliminando plan anterior...');
                await supabaseClient
                    .from('plan_cuentas_cliente')
                    .delete()
                    .eq('cliente_id', clienteSeleccionado);

                // Insertar nuevas cuentas en lotes de 100
                actualizarLoadingText('Guardando cuentas...');
                const batchSize = 100;
                for (let i = 0; i < cuentas.length; i += batchSize) {
                    const batch = cuentas.slice(i, i + batchSize);
                    const { error } = await supabaseClient
                        .from('plan_cuentas_cliente')
                        .insert(batch);

                    if (error) throw error;

                    actualizarLoadingText(`Guardando cuentas... ${Math.min(i + batchSize, cuentas.length)}/${cuentas.length}`);
                }

                ocultarLoading();
                alert(`Plan de cuentas importado exitosamente: ${cuentas.length} cuentas`);

                // Recargar datos
                await cargarPlanCuentasCliente(clienteSeleccionado);
                await cargarClientes(); // Actualizar contadores

                // Limpiar input
                event.target.value = '';

            } catch (err) {
                ocultarLoading();
                console.error('Error procesando archivo:', err);
                alert('Error al procesar el archivo: ' + err.message);
            }
        }

        // ============================================
        // ELIMINAR PLAN DE CUENTAS
        // ============================================
        async function eliminarPlanCuentas() {
            if (!clienteSeleccionado) return;

            const confirmar = confirm('¬øEst√° seguro de eliminar todo el plan de cuentas de este cliente?\n\nEsta acci√≥n no se puede deshacer.');
            if (!confirmar) return;

            mostrarLoading('Eliminando plan de cuentas...');

            try {
                // Eliminar tambi√©n los mapeos
                await supabaseClient
                    .from('mapeo_cuentas_cliente')
                    .delete()
                    .eq('cliente_id', clienteSeleccionado);

                // Eliminar plan
                const { error } = await supabaseClient
                    .from('plan_cuentas_cliente')
                    .delete()
                    .eq('cliente_id', clienteSeleccionado);

                if (error) throw error;

                ocultarLoading();
                alert('Plan de cuentas eliminado');

                // Recargar
                await cargarPlanCuentasCliente(clienteSeleccionado);
                await cargarClientes();

            } catch (err) {
                ocultarLoading();
                console.error('Error eliminando plan:', err);
                alert('Error al eliminar: ' + err.message);
            }
        }

        // ============================================
        // DESCARGAR PLANTILLA
        // ============================================
        function descargarPlantilla() {
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['CODIGO', 'CUENTA'],
                ['1.1.01.001', 'Caja en Pesos'],
                ['1.1.01.002', 'Banco Naci√≥n Cta. Cte.'],
                ['1.1.02.001', 'Deudores por Ventas'],
                ['2.1.01.001', 'Proveedores'],
                ['3.1.01.001', 'Capital Social'],
                ['4.1.01.001', 'Ventas'],
                ['5.1.01.001', 'Costo de Mercader√≠as Vendidas']
            ];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Ajustar anchos de columna
            ws['!cols'] = [
                { wch: 15 },
                { wch: 40 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Plan de Cuentas');
            XLSX.writeFile(wb, 'plantilla_plan_cuentas.xlsx');
        }

        // ============================================
        // DRAG & DROP
        // ============================================
        function configurarDragDrop() {
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragging');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragging');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragging');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        // Simular selecci√≥n de archivo
                        const fileInput = document.getElementById('fileInput');
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;
                        procesarArchivoExcel({ target: fileInput });
                    } else {
                        alert('Por favor seleccione un archivo Excel (.xlsx o .xls)');
                    }
                }
            });
        }

        // ============================================
        // LOADING
        // ============================================
        function mostrarLoading(texto = 'Cargando...') {
            document.getElementById('loadingText').textContent = texto;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function ocultarLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function actualizarLoadingText(texto) {
            document.getElementById('loadingText').textContent = texto;
        }
    </script>
</body>
</html>
