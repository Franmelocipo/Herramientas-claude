<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Cliente - Servicios de Outsourcing</title>

    <!-- Estilos -->
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Estilos para el modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .modal-content label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 500;
            color: #34495e;
        }

        .modal-content select,
        .modal-content input[type="file"],
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .modal-content textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .modal-buttons {
            margin-top: 25px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .modal-buttons button:first-child {
            background-color: #95a5a6;
            color: white;
        }

        .modal-buttons button:first-child:hover {
            background-color: #7f8c8d;
        }

        .btn-primary {
            background-color: #3498db !important;
            color: white !important;
        }

        .btn-primary:hover {
            background-color: #2980b9 !important;
        }

        .btn-primary:disabled {
            background-color: #bdc3c7 !important;
            cursor: not-allowed;
        }

        /* Estilos para la informaci√≥n del cliente */
        .cliente-info {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .cliente-info strong {
            color: #2c3e50;
            font-size: 14px;
        }

        .cliente-info span {
            color: #34495e;
            font-size: 16px;
            font-weight: 500;
        }

        /* Estilos para la lista de comprobantes */
        .comprobante-item {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .comprobante-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-color: #3498db;
        }

        .comprobante-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .comprobante-info strong {
            color: #2c3e50;
            font-size: 16px;
        }

        .comprobante-info span {
            color: #7f8c8d;
            font-size: 13px;
        }

        .comprobante-tipo {
            display: inline-block;
            padding: 3px 8px;
            background-color: #ecf0f1;
            border-radius: 3px;
            font-size: 12px;
            text-transform: capitalize;
        }

        .estado-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: capitalize;
        }

        .estado-pendiente {
            background-color: #fff3cd;
            color: #856404;
        }

        .estado-procesado {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .estado-completado {
            background-color: #d4edda;
            color: #155724;
        }

        .comprobante-acciones {
            display: flex;
            gap: 10px;
        }

        .comprobante-acciones a {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.3s;
        }

        .comprobante-acciones a:hover {
            background-color: #2980b9;
        }

        .empty-message {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #3498db;
        }

        /* Estilos para las secciones */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .action-button {
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .action-button:hover {
            background-color: #2980b9;
        }

        .action-button-large {
            padding: 16px 32px;
            font-size: 16px;
        }
    </style>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Servicios</h1>
                <div class="user-info">
                    <span id="userName">Cargando...</span>
                </div>
                <span class="user-role">Cliente</span>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">Menu</span>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" onclick="mostrarSeccion('subir'); return false;">
                                <span class="icon">üì§</span>
                                Subir Comprobantes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" onclick="mostrarSeccion('mis-comprobantes'); return false;">
                                <span class="icon">üìã</span>
                                Mis Comprobantes
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="btn-logout" onclick="auth.logout()">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </aside>

        <!-- Contenido principal -->
        <main class="main-content">
            <div class="content-header">
                <h1 id="welcomeMessage">Bienvenido</h1>
                <div class="cliente-info" id="clienteInfoContainer" style="display: none;">
                    <strong>Cliente:</strong> <span id="nombreCliente">Cargando...</span>
                </div>
                <p>Panel de servicios de outsourcing</p>
            </div>

            <!-- Secci√≥n: Subir Comprobantes -->
            <div id="seccion-subir" class="content-section active">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Subir Comprobantes</h3>
                    </div>
                    <div class="card-body">
                        <p style="margin-bottom: 20px; color: #555;">
                            Puede subir sus comprobantes en formato PDF. Los archivos ser√°n procesados por nuestro equipo.
                        </p>
                        <button class="action-button action-button-large" onclick="abrirModalSubir()">
                            üì§ Nuevo Comprobante
                        </button>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n: Mis Comprobantes -->
            <div id="seccion-mis-comprobantes" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Mis Comprobantes</h3>
                    </div>
                    <div class="card-body">
                        <div id="listaComprobantes">
                            <div class="loading-spinner">
                                <p>Cargando comprobantes...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para subir comprobante -->
    <div id="modalSubirComprobante" class="modal">
        <div class="modal-content">
            <h3>Subir Comprobante</h3>

            <label>Tipo de Comprobante:</label>
            <select id="tipoComprobante">
                <option value="factura">Factura</option>
                <option value="recibo">Recibo</option>
                <option value="nota_credito">Nota de Cr√©dito</option>
                <option value="nota_debito">Nota de D√©bito</option>
                <option value="otro">Otro</option>
            </select>

            <label>Archivo (PDF):</label>
            <input type="file" id="archivoComprobante" accept="application/pdf">

            <label>Notas (opcional):</label>
            <textarea id="notasComprobante" placeholder="Observaciones adicionales..."></textarea>

            <div class="modal-buttons">
                <button onclick="cerrarModalSubir()">Cancelar</button>
                <button id="btnSubir" class="btn-primary" onclick="subirComprobante()">Subir</button>
            </div>
        </div>
    </div>

    <!-- Script de autenticaci√≥n -->
    <script src="auth.js"></script>

    <script>
        let sessionData = null;

        // Verificar sesi√≥n al cargar
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar que sea cliente
            const session = auth.requireRole('cliente');

            if (!session) {
                return;
            }

            sessionData = session;

            // Mostrar nombre del usuario
            document.getElementById('userName').textContent = session.nombre;
            document.getElementById('welcomeMessage').textContent = `Bienvenido ${session.nombre}`;

            // Cargar informaci√≥n del cliente asignado
            await cargarInfoCliente();

            console.log('Usuario cliente cargado. Cliente ID:', session.cliente_id);
        });

        // Cargar informaci√≥n del cliente asignado
        async function cargarInfoCliente() {
            try {
                const { data, error } = await supabaseClient
                    .from('usuarios_comprobantes')
                    .select(`
                        nombre,
                        email,
                        cliente_id,
                        clientes(razon_social, cuit)
                    `)
                    .eq('id', sessionData.userId)
                    .single();

                if (error) {
                    console.error('Error al cargar informaci√≥n del cliente:', error);
                    return;
                }

                if (data && data.clientes) {
                    document.getElementById('nombreCliente').textContent = data.clientes.razon_social;
                    document.getElementById('clienteInfoContainer').style.display = 'block';
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        // Mostrar secci√≥n espec√≠fica
        function mostrarSeccion(seccion) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(s => {
                s.classList.remove('active');
            });

            // Remover clase active de todos los links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Mostrar la secci√≥n seleccionada
            if (seccion === 'subir') {
                document.getElementById('seccion-subir').classList.add('active');
                document.querySelector('a[onclick*="subir"]').classList.add('active');
            } else if (seccion === 'mis-comprobantes') {
                document.getElementById('seccion-mis-comprobantes').classList.add('active');
                document.querySelector('a[onclick*="mis-comprobantes"]').classList.add('active');
                cargarComprobantes();
            }
        }

        // Abrir modal de subir comprobante
        function abrirModalSubir() {
            document.getElementById('modalSubirComprobante').style.display = 'block';
        }

        // Cerrar modal de subir comprobante
        function cerrarModalSubir() {
            document.getElementById('modalSubirComprobante').style.display = 'none';
            document.getElementById('archivoComprobante').value = '';
            document.getElementById('notasComprobante').value = '';
            document.getElementById('tipoComprobante').value = 'factura';
        }

        // Cerrar modal al hacer clic fuera de √©l
        window.onclick = function(event) {
            const modal = document.getElementById('modalSubirComprobante');
            if (event.target === modal) {
                cerrarModalSubir();
            }
        }

        // Subir comprobante
        async function subirComprobante() {
            console.log('=== Iniciando subida de comprobante ===');

            const archivo = document.getElementById('archivoComprobante').files[0];
            const tipo = document.getElementById('tipoComprobante').value;
            const notas = document.getElementById('notasComprobante').value;

            console.log('Archivo seleccionado:', archivo);
            console.log('Tipo:', tipo);

            if (!archivo) {
                alert('Seleccione un archivo');
                return;
            }

            if (archivo.type !== 'application/pdf') {
                alert('Solo se permiten archivos PDF');
                return;
            }

            try {
                const sesionStr = localStorage.getItem('sesion_outsourcing');
                console.log('Sesi√≥n string:', sesionStr);

                if (!sesionStr) {
                    alert('Sesi√≥n expirada. Por favor vuelva a iniciar sesi√≥n.');
                    window.location.href = 'login.html';
                    return;
                }

                const sesion = JSON.parse(sesionStr);
                console.log('Sesi√≥n parseada:', sesion);
                console.log('clienteId:', sesion.clienteId);
                console.log('userId:', sesion.userId);

                if (!sesion.clienteId) {
                    alert('Error: No se encontr√≥ el ID del cliente. Por favor cierre sesi√≥n y vuelva a iniciar.');
                    return;
                }

                // Nombre √∫nico para el archivo
                const timestamp = Date.now();
                const nombreArchivo = `${timestamp}_${archivo.name}`;
                const rutaArchivo = `${sesion.clienteId}/${nombreArchivo}`;

                console.log('Ruta del archivo:', rutaArchivo);
                console.log('Iniciando upload a Storage...');

                // Subir a Supabase Storage
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('comprobantes')
                    .upload(rutaArchivo, archivo, {
                        cacheControl: '3600',
                        upsert: false
                    });

                console.log('Upload data:', uploadData);
                console.log('Upload error:', uploadError);

                if (uploadError) {
                    console.error('Error en upload:', uploadError);
                    throw uploadError;
                }

                // Obtener URL p√∫blica
                const { data: urlData } = supabaseClient.storage
                    .from('comprobantes')
                    .getPublicUrl(rutaArchivo);

                console.log('URL p√∫blica:', urlData.publicUrl);

                // Guardar en base de datos
                console.log('Guardando en base de datos...');
                const { data: dbData, error: dbError } = await supabaseClient
                    .from('comprobantes')
                    .insert({
                        cliente_id: sesion.clienteId,
                        usuario_subio_id: sesion.userId,
                        archivo_url: urlData.publicUrl,
                        archivo_nombre: archivo.name,
                        tipo_comprobante: tipo,
                        notas: notas,
                        estado: 'pendiente'
                    })
                    .select();

                console.log('DB data:', dbData);
                console.log('DB error:', dbError);

                if (dbError) {
                    console.error('Error en DB:', dbError);
                    throw dbError;
                }

                console.log('Comprobante subido exitosamente');
                alert('¬°Comprobante subido exitosamente!');

                cerrarModalSubir();
                cargarComprobantes();

            } catch (err) {
                console.error('Error completo:', err);
                alert('Error al subir comprobante: ' + err.message);
            }
        }

        // Cargar comprobantes
        async function cargarComprobantes() {
            const contenedor = document.getElementById('listaComprobantes');

            // Mostrar loading
            contenedor.innerHTML = '<div class="loading-spinner"><p>Cargando comprobantes...</p></div>';

            try {
                const { data, error } = await supabaseClient
                    .from('comprobantes')
                    .select('*')
                    .eq('cliente_id', sessionData.cliente_id)
                    .order('fecha_subida', { ascending: false });

                if (error) {
                    console.error('Error al cargar comprobantes:', error);
                    contenedor.innerHTML = '<div class="empty-message"><p>‚ùå Error al cargar los comprobantes</p></div>';
                    return;
                }

                if (!data || data.length === 0) {
                    contenedor.innerHTML = `
                        <div class="empty-message">
                            <p>üìã No hay comprobantes subidos todav√≠a</p>
                            <button class="action-button" onclick="mostrarSeccion('subir')" style="margin-top: 15px;">
                                Subir primer comprobante
                            </button>
                        </div>
                    `;
                    return;
                }

                // Renderizar lista de comprobantes
                renderizarListaComprobantes(data);

            } catch (err) {
                console.error('Error:', err);
                contenedor.innerHTML = '<div class="empty-message"><p>‚ùå Error al cargar los comprobantes</p></div>';
            }
        }

        // Renderizar lista de comprobantes
        function renderizarListaComprobantes(comprobantes) {
            const html = comprobantes.map(c => {
                const fecha = new Date(c.fecha_subida).toLocaleDateString('es-AR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="comprobante-item">
                        <div class="comprobante-info">
                            <strong>üìÑ ${c.archivo_nombre}</strong>
                            <div>
                                <span class="comprobante-tipo">${formatearTipo(c.tipo_comprobante)}</span>
                                <span> ‚Ä¢ ${fecha}</span>
                            </div>
                            ${c.notas ? `<span style="color: #555;">üìù ${c.notas}</span>` : ''}
                            <span class="estado-badge estado-${c.estado}">${formatearEstado(c.estado)}</span>
                        </div>
                        <div class="comprobante-acciones">
                            <a href="${c.archivo_url}" target="_blank" rel="noopener noreferrer">üëÅÔ∏è Ver PDF</a>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('listaComprobantes').innerHTML = html;
        }

        // Formatear tipo de comprobante
        function formatearTipo(tipo) {
            const tipos = {
                'factura': 'Factura',
                'recibo': 'Recibo',
                'nota_credito': 'Nota de Cr√©dito',
                'nota_debito': 'Nota de D√©bito',
                'otro': 'Otro'
            };
            return tipos[tipo] || tipo;
        }

        // Formatear estado
        function formatearEstado(estado) {
            const estados = {
                'pendiente': 'Pendiente',
                'procesado': 'Procesado',
                'completado': 'Completado'
            };
            return estados[estado] || estado;
        }
    </script>
</body>
</html>
